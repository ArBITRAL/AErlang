-module(aman).
-compile({parse_transform,aerl_trans}).
-compile(export_all).

init(Env,Prefs) ->
    spawn(?MODULE, start, [Env,Prefs]).

start(Env,Prefs) ->
    aerl_env:initEnv(Env),
    aerl:setAtt(prefs,Prefs),
    aerl:setAtt(candidate,[]),
    receive
	start -> loop(Prefs,0)
    end.

loop(_,10) ->
    global:whereis_name(log) ! stop,
    io:format("Man ~p is alone after ~p try~n",[aerl:getAtt(id),9]);
loop([],Status) ->
    Prefs = aerl:getAtt(prefs),
    aerl:setAtt(partner,none),
    loop(Prefs,Status+1);
loop([H|T],Status) ->
    aerl:setAtt(candidate,[]),
    [Id] = aerl:getAtts([id]),
    Ref = make_ref(),
    Count = to_c("id in $H") ! {Ref, propose, Id, Status},
    from("sex = _woman",Count),
    receive
    	{Ref, yes, Wid} ->
    	    case aerl:getAtt(partner) of
    		none ->
		    %%io:format("~p confirm to ~p~n",[Id,Wid]),
    		    to("id = $Wid") ! {Ref, confirm,Id},
    		    aerl:setAtt(partner,Wid);

    		_ ->
    		    to("id = $Wid") ! {Ref, sorry,Id},
    		    Try = aerl:getAtt(candidate),
    		    aerl:setAtt(candidate,[Wid|Try])
    	    end;
    	{Ref, no, _} -> fine
    end,
    Partner = aerl:getAtt(partner),
    case Partner of
    	none ->
    	    loop(T,Status);
    	_ ->
    	    receive
    		{no, Partner} ->
    		    aerl:setAtt(partner,none),
    		    Try = aerl:getAtt(candidate),
    		    loop(Try++T,Status)
    	    end
    end.


better(none,L) ->
    L;
better(E,L) ->
    lists:reverse(cut(E,lists:reverse(L))).

cut(_,[]) -> [];
cut(E,[E|T]) ->
    [E|T];
cut(E,[H|T]) when is_list(H) ->
    case lists:member(E,H) of
	true ->
	    [H|T];
	false ->
	    cut(E,T)
    end;
cut(E,[H|T]) ->
    cut(E,T).

    %% Rhelper = fun
    %% 		  F1(0,Try) -> loop(Try++T,Status);
    %% 		  F1(Num,Try) ->
    %% 		      from("sex = _woman"),
    %% 		      receive
    %% 			  {yes, Wid} ->
    %% 			      case aerl:getAtt(partner) of
    %% 				  none ->
    %% 				      to("id = $Wid") ! {confirm,Id},
    %% 				      aerl:setAtt(partner,Wid),
    %% 				      F1(Num,Try);
    %% 				  _ ->
    %% 				      to("id = $Wid") ! {sorry,Id},
    %% 				      F1(Num-1,Try)
    %% 			      end;
    %% 			  {restart, _Other} ->
    %% 			      loop([], Status);
    %% 			  {no, Other} ->
    %% 			      case aerl:getAtt(partner) of
    %% 				  Other ->
    %% 				      aerl:setAtt(partner,none);
    %% 				  _ -> fine
    %% 			      end,
    %% 			      F1(Num-1,Try--[Other])
    %% 		      end
    %% 	      end,
    %% case is_list(H) of
    %% 	true -> Rhelper(Count,H);
    %% 	false -> Rhelper(Count,[H])
    %% end.
