-module(awoman).
-compile({parse_transform,aerl_trans}).
-compile(export_all).

% AbC code for woman
% W:= (x=propose)(x,y).(<BOF(this.partner,y)>[this.ex:=this.partner;this.partner:=y](invalid)@(mid=this.ex).0
% + <not BOF(this.partner,y)>(invalid)@(mid=y).0).W
%

% using map to store environment

init(Env) ->
    spawn(fun() ->
		  start(Env) end).

start(Env) ->
    aerl:register(Env),
    io:format("Woman <~p> ~p start!~n",[self(),maps:get(id,Env)]),
    loop(Env).

loop(Env) ->
    #{prefs:=L, partner:=Partner, id:=Id, prior:=Param} = Env,
    io:format("Woman ~p has current partner ~p with score ~p~n",[Id,Partner,Param]),
    from("X = propose"), receive
	{X,Mid,W,B} ->
		case bof(L, Param, W, B) of
			{true,Prior} ->
		  	 	NEnv = Env#{ex:=Partner, partner:=Mid, prior:=Prior},
				to("id = this.ex") ! {{no, Id},NEnv},
				to("id = this.partner") ! {{yes, Id},NEnv},
				loop(NEnv);
			{false,_} ->
				to("id = $Mid") ! {{no, Id},Env},
				loop(Env)
		end
	end.

%bof(_, -1, _ , _) -> {true,-1};
bof(L, Param, W, B) ->
  #{wealth := X, body := Y} = L,
  Score = case {X,Y} of
      {W,B} -> 3;
      {W,_} -> 2;
      {_,B} -> 1;
      _Other ->0
  end,
  {Score >= Param,Score}.
